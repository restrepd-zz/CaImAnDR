# CaImAnDR
Code to process GCaMP imaging data with CaImAn

This is the code for Ming’s paper: doi: https://doi.org/10.1101/2019.12.14.876201

The code uses CaImAn to analyze GCaMP dF/F imaging data.


Ming’s software

Motion correction
Ming uses TurboReg, a plugin for ImageJ for the motion correction. 

http://akiramuto.net/archives/208

CalmAn
We then use CaImAn to find ROIs. Please set the MATLAB path to CaImAn because some routines are used by drgCaImAn_script

https://github.com/flatironinstitute/CaImAn-MATLAB

Olfactometer/readdropcspm_hf
This program is used to generate the percent correct vs trial plots. The input is from spm.mat files

CaImAnDR/drgCalmAn_script. Finds components (ROIs) using CaImAn code. It ouputs a file called file_name_CalmAn.mat.

CaImAnDR /drgCalmAn_dropc. This routine takes the output from drgCalmAn_script (file_name_CalmAn.mat), the lick recordings from the INTAN board (.rhd format) and metadata from dropcspm_hf.m to generate average deltaF/F and lick traces. 

The output is saved in a file with the suffix _pre_per.mat

The output can be used for perceptron analysis, etc.

CaImAnDR/drgCaImAn_batch_dropc. This does a batch of warping and drgCalmAn_dropc. If you want warping enter

do_warp=1; 

If you do not want to warp

do_warp=0;

You need to have a file called:

drgCaImAn_dropc_choices_some_name.m

that has all the files to be processed.


CaImAnDR /drgCaImAn_dropc_correlation. This routine takes the output from drgCalmAn_script (file_name_CalmAn.mat), the lick recordings from the INTAN board (.rhd format) and metadata from dropcspm_hf.m to calculate correlation (and covariance) of Ca traces between components. The covariance is an input to for simulations.

CaImAnDR /drgCaImAn_average_betweenSession_dFF averages the data between different sessions. It needs the output file generated by drgCaImAnBatchPerSession


 

CaImAnDR /drgCaImAnBatchPerSession. This routine takes input from a file named drgCaImAnChoices_name of the file.m

It uses the output of drgCaImAn_dropc to perform whole session analysis. Make sure to list the files in the Choices file in order of acquisition.

It generates:
 

CaImAnDR /drgCaImAnBatchPerSessionReversal. This is used for the reversal figure. This routine takes input from a file named drgCaImAnChoices_name of the file.m

It uses the output of drgCaImAn_dropc to perform whole session analysis. Make sure to list the files in the Choices file in order of acquisition.

This code accepts multiple sessions

 


CaImAnDR/drgOpticalFlowEstimate. Optical Flow Estimation Using the Farneback Algorithm 
The input is the .mp4 movie. Saves _optflow.mat

CaImAnDR/drgOpticalFlowEstimateBatch
Batch optical flow estimation for multiple files using the Farneback algorithm. This code needs a choices file containing the names of the .mp4 input files (like drgOptFlowChoices20180419_mmG06_cerebellum.mat). The output is one _optflow.mat file for each input file.

CaImAnDR/drgOpticalFlowAligned. Alignment of Optical Flow Estimation with the deltaF/F 

The inputs are the pre_per.mat generated by drgCalmAn_dropc_plot and optflow.mat generated by drgOpticalFlowEstimate.

CaImAnDR/drgAlignOpticalFlow. Allows the user to find whether the alignment is correct.


CaImAnDR/drgCaImAnBatchPerSessionEventsPerTriallickvsdFFOptFlow. This code does a movement and lick derivative analysis per trial. The program needs a choices file such as drgCaImAnChoicesDiego20180910_mmPVG04_CerebellumLDAOpFlow

CaImAnDR/drgCaImAnBatchPerSessionEventsPerTriallickvsdFFOptFlowDimensionality. This code does a dimensionality analysis.

CaImAnDR/drgCaImAn_glm. This code does the glm analysis of a file generated by drgCaImAnBatchPerSessionEventsPerTriallickvsdFFOptFlow.m

CaImAnDR/drgCaImAn_dropc_perceptron. Performs perceptron analysis.

CaImAnDR/drgCaImAn_rainbow. Generates pseudocolor plots of the deltaF/F traces per ROI

CaImAnDR/drgCaImAn_get_warped_components. This function warps the ROIs of the reference tif to the other tif. It saves data appropriate for drgCalmAn_dropc


CaImAnDR/drgCaImAn_average_betweenSession_dFF averages the data between different
sessions. It needs the output file generated by drgCaImAnBatchPerSession

 

drgCaImAnBatchPerSessionReversalPerTrial
Needs a choices file such as drgCaImAnChoicesDiego20180910_mmPVG04_Cerebellum. Needs the output files from drgCaImAn_batch_dropc.m

drgCaImAnBatchPerSessionReversalPerTrialLDA. Generated the example of LDA timecourse in Ming’s Fig. 3. This example is generated with drgCaImAnChoicesDiego20180910_mmPVG04_CerebellumLDA

drgCaImAnBatchPerSessionEventsPerTrialPCA
Sorts the predicted responses for Hit, Miss, CR and FA and generates a PCA analysis plot. It needs as input the output files of drgCaImAn_batch_dropc and a choices file such as drgCaImAnChoicesDiego20180910_mmPVG04_CerebellumLDA defining the windows (3-4 sec, etc) and making sure the sessions do not include reversals.

drgCaImAnBatchPerSessionEventsPerTrialLDA 
Sorts the predicted responses for Hit, Miss, CR and FA and generates the output file for lda_per_event_all_files.m. It needs as input the output files of drgCaImAn_batch_dropc and a choices file such as drgCaImAnChoicesDiego20180910_mmPVG04_CerebellumLDA defining the windows (3-4 sec, etc) and making sure the sessions do not include reversals.

lda_per_event_all_files.m 
Generates LDAperevent.fig showing that the Ca changes during mistakes can predict the odor, with some very interesting exceptions. It needs input generated by drgCaImAnBatchPerSessionEventsPerTrialLDA

drgCaImAnBatchPerSessionEventsPerTriallickvsdFF
Does the analysis of the slope of lick frequency vs. slope of dFF (as in Gaffield 2017). It needs as input the output files of drgCaImAn_batch_dropc and a choices file such as drgCaImAnChoicesDiego20180910_mmPVG04_

drgCaImAnPerTrialLDASubsampleSimulation
This code simulates activity of multiple components with different covariant activity to analyze the dependence of LDA prediction on the number of components


drgCaImAn_batch_dropc_no_microscope.m
This is used to process files acquired in a session to study the changes
in behavior and licks when the MLIs are activated with optogenetics
Needs as an input the ouput files from the dropcspm_hf.m (.mat) and from
INTAN (.rhd)
Needs a dropc choices file such as
drgCaImAn_dropc_choices_PVhM4Di_04292019.m
or if you want to save time typing:
drgCaImAn_dropc_choices_PVhM4Di_all_files_04292019.m


drgCaImAnBatchPerSessionLicks
This code does a lick analysis for sessions where we record the behavior and licks
for optogenetic modulation of behavior/licks by turning MLIs with
optogenetics
Needs a choices file such as
drgCaImAnChoices_20190312_mmPVsoChR02_Cerebellum_licks.m
% Needs the output files from drgCaImAn_batch_dropc_no_microscope.m

drgCaImAnBatchMultiSessionLicks
drgCaImAn_multichoices_PVhM4Di_all_files_05052019


drgCaImAnBatchPerSessionPerTrialLDASubsample
This code does a linear discriminant analysis for spm data using subsets of components
Needs a choices file such as drgCaImAnChoicesDiego20180910_mmPVG04_Cerebellum
Needs the output files from drgCaImAn_batch_dropc.m

Zoe Donaldson’s LDA demo

This is a demo of our use of LDA

LDA_demo calls drgCaImAnLDAtimecourse.m to process data from Ming’s Figure 3C (MLI data.mat data available on request).

drgCaImAnLDAtimecourse performs LDA for MLI data.mat


Connor McCoullough’s software

drgcmCaImAn_batch_dropc_rhd.m reads the images, olfactometer file and rhd for Connor’s analysis. You need a choices file such as drgCaImAn_dropc_rhd_choices_157565_9_27CA.m


drgcmPostHocLickReward.m re-evaluates the scoring of the hits, CRs, etc.

drgcmCrossPCArhddFF takes as an input the *_batch_per_file.mat and outputs the correlations between LFP and dFF.

drgCaImAn_dropc_nsampler



